<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Check In</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0f766e">
  <meta name="color-scheme" content="light dark">
  <link rel="icon" href="./icons/icon-192.png">
  <style>
    :root { --c:#0f766e; --bg:#fff; --fg:#111; --muted:#6b7280; --ring:rgba(15,118,110,.18); }
    @media (prefers-color-scheme: dark){
      :root { --bg:#0b0f10; --fg:#e5e7eb; --muted:#9ca3af; --ring:rgba(34,197,94,.25);}
    }
    html,body{height:100%}
    body { margin: 24px; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 640px;
           color: var(--fg); background: var(--bg); }
    h1 { margin: 0 0 12px 0; }
    .row { display:flex; justify-content:space-between; align-items:baseline; padding:10px 0; border-bottom: 1px dashed #e5e7eb22; }
    .row strong{font-weight:600}
    .toolbar { display:flex; gap:10px; margin-top: 18px; flex-wrap: wrap; }
    button { padding: 12px 16px; font-size: 16px; border: 0; border-radius: 10px; background: var(--c); color:#fff; cursor:pointer; }
    button.ghost{ background:#e6f3f2; color:#063d38; }
    @media (prefers-color-scheme: dark){
      button.ghost{ background:#103a36; color:#d1fae5; }
    }
    button:disabled{ opacity:.55; cursor:not-allowed }
    .muted{ color: var(--muted); font-size: 14px; }
    dialog::backdrop { background: rgba(0,0,0,.45); }
    dialog { border: 0; border-radius: 14px; padding: 18px; width: min(92vw, 560px); color: var(--fg); background: var(--bg); }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    input[type="text"], input[type="time"]{ padding: 12px 12px; border: 1px solid #33415555; border-radius: 10px; font-size: 16px; background: transparent; color: var(--fg); }
    input[type="text"]:focus, input[type="time"]:focus{ outline: none; box-shadow: 0 0 0 4px var(--ring); border-color: transparent; }
    .err{ color:#ef4444; font-size: 13px; min-height: 1.2em; }
    .actions{ display:flex; justify-content:flex-end; gap:10px; margin-top: 12px; }
    .kpi{ font-variant-numeric: tabular-nums; font-feature-settings: "tnum"; }
    .radio-row{ display:flex; gap:12px; align-items:center; }
    .radio{ display:flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #33415533; border-radius:10px; cursor:pointer; }
    .radio input{ accent-color: var(--c); }
  </style>
</head>
<body>
  <h1 id="t-title">Work Shift</h1>

  <div class="row"><strong id="t-checkin">Check-in</strong><span id="in" class="kpi">â€”</span></div>
  <div class="row"><strong id="t-total">Total (Work + Break + Recovery)</strong><span id="sum" class="kpi">â€”</span></div>
  <div class="row"><strong id="t-checkout">Check-out</strong><span id="out" class="kpi">â€”</span></div>

  <div class="toolbar">
    <button id="checkin" disabled><span id="t-btn-checkin">Check-in</span></button>
    <button id="reset" class="ghost" disabled><span id="t-btn-reset">Reset</span></button>
    <button id="settings" class="ghost"><span id="t-btn-settings">Settings</span></button>
  </div>
  <p class="muted" id="t-hint">12-hour format for English, 24-hour for Italian. Installable offline PWA. Data stored locally.</p>

  <!-- Settings dialog -->
  <dialog id="dlg">
    <h2 id="t-dlg-title" style="margin:0 0 8px 0">Settings</h2>
    <p id="t-dlg-desc" class="muted" style="margin-top:0">
      Enter durations in <b>HH:MM</b> (e.g. 08:36, 00:30). The app remains locked until valid values are saved for Work and Lunch break.
    </p>

    <!-- Language selector -->
    <div class="field">
      <label id="t-lang-label">Language</label>
      <div class="radio-row">
        <label class="radio"><input type="radio" name="lang" value="en" id="lang-en"><span>ðŸ‡ºðŸ‡¸ English</span></label>
        <label class="radio"><input type="radio" name="lang" value="it" id="lang-it"><span>ðŸ‡®ðŸ‡¹ Italiano</span></label>
      </div>
    </div>

    <div class="grid">
      <div class="field">
        <label id="t-lbl-work" for="durWork">Work duration (HH:MM)</label>
        <input id="durWork" type="text" placeholder="08:36" autocomplete="off">
        <div id="errWork" class="err"></div>
      </div>
      <div class="field">
        <label id="t-lbl-break" for="durBreak">Lunch break (HH:MM)</label>
        <input id="durBreak" type="text" placeholder="00:30" autocomplete="off">
        <div id="errBreak" class="err"></div>
      </div>
      <div class="field">
        <label id="t-lbl-recovery" for="durRecovery">Recovery Time (HH:MM, optional)</label>
        <input id="durRecovery" type="text" placeholder="00:00" autocomplete="off">
        <div id="errRecovery" class="err"></div>
      </div>
      <div class="field" style="grid-column: 1 / -1;">
        <label id="t-lbl-manual" for="manualCheckIn">Manual check-in (today, HH:MM) â€” optional</label>
        <input id="manualCheckIn" type="time" step="60" placeholder="09:00" autocomplete="off">
        <div id="errManual" class="err"></div>
        <span class="muted" id="t-lbl-manual-help">If provided, todayâ€™s check-in will be set to this time when you press Save.</span>
      </div>
    </div>
    <div class="actions">
      <button id="save"><span id="t-btn-save">Save</span></button>
    </div>
  </dialog>

  <script>
    const K_W='workDurationHM',K_B='breakDurationHM',K_R='recoveryDurationHM',K_IN='checkinEpochMs',K_LANG='lang';
    const I18N={en:{title:"Work Shift",checkin:"Check-in",total:"Total (Work + Break + Recovery)",checkout:"Check-out",
      btn_checkin:"Check-in",btn_reset:"Reset",btn_settings:"Settings",
      hint:"12-hour format. Installable offline PWA. Data stored locally.",
      dlg_title:"Settings",dlg_desc:"Enter durations in <b>HH:MM</b> (e.g. 08:36, 00:30). The app remains locked until valid values are saved.",
      lang_label:"Language",lbl_work:"Work duration (HH:MM)",lbl_break:"Lunch break (HH:MM)",
      lbl_recovery:"Recovery Time (HH:MM, optional)",lbl_manual:"Manual check-in (today, HH:MM) â€” optional",
      lbl_manual_help:"If provided, todayâ€™s check-in will be set to this time when you press Save.",
      btn_save:"Save",err_work:"Enter valid HH:MM (> 00:00)",err_break:"Enter valid HH:MM (â‰¥ 00:00)",err_recovery:"Enter valid HH:MM (â‰¥ 00:00)",err_manual:"Invalid time. Use HH:MM (12h)."},
      it:{title:"Turno di lavoro",checkin:"Check-in",total:"Totale (Lavoro + Pausa + Recupero)",checkout:"Check-out",
      btn_checkin:"Check-in",btn_reset:"Reset",btn_settings:"Impostazioni",
      hint:"Formato 24 ore. PWA installabile offline. Dati salvati in locale.",
      dlg_title:"Impostazioni",dlg_desc:"Inserisci le durate in <b>HH:MM</b> (es. 08:36, 00:30). Lâ€™app resta bloccata finchÃ© non salvi valori validi.",
      lang_label:"Lingua",lbl_work:"Orario di lavoro (HH:MM)",lbl_break:"Pausa pranzo (HH:MM)",
      lbl_recovery:"Tempo di Recupero (HH:MM, opzionale)",lbl_manual:"Check-in manuale (oggi, HH:MM) â€” opzionale",
      lbl_manual_help:"Se compilato, il check-in di oggi verrÃ  impostato a questâ€™ora quando premi Salva.",
      btn_save:"Salva",err_work:"Inserisci HH:MM valido (> 00:00)",err_break:"Inserisci HH:MM valido (â‰¥ 00:00)",err_recovery:"Inserisci HH:MM valido (â‰¥ 00:00)",err_manual:"Ora non valida. Usa HH:MM (24h)."}};

    const $=s=>document.querySelector(s); const TX=Object.fromEntries([...document.querySelectorAll('[id^="t-"]')].map(e=>[e.id.replace('t-',''),e]));
    let fmtClock=new Intl.DateTimeFormat('en-US',{hour:'2-digit',minute:'2-digit',hour12:true});
    const ERR={};
    function setLang(lang){const L=I18N[lang];for(const k in TX){if(TX[k])TX[k].innerHTML=L[k]||TX[k].innerHTML;}
      $('#durWork').placeholder='08:36';$('#durBreak').placeholder='00:30';$('#durRecovery').placeholder='00:00';
      (lang==='it'?$('#lang-it'):$('#lang-en')).checked=true;localStorage.setItem(K_LANG,lang);
      ERR.work=L.err_work;ERR.break=L.err_break;ERR.recovery=L.err_recovery;ERR.manual=L.err_manual;
      fmtClock=new Intl.DateTimeFormat(lang==='it'?'it-IT':'en-US',{hour:'2-digit',minute:'2-digit',hour12:lang!=='it'});}
    function parseHM(s){if(!s)return null;s=s.trim();if(!s)return 0;const m=/^(\d{1,2})\s*:\s*([0-5]\d)$/.exec(s);if(!m)return null;return +m[1]*60+ +m[2];}
    function fmtHM(n){const h=Math.floor(n/60),m=n%60;return`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;}
    const getDur=()=>({W:parseHM(localStorage.getItem(K_W)),B:parseHM(localStorage.getItem(K_B)),R:parseHM(localStorage.getItem(K_R)||'00:00')});
    function setManual(t){const m=/^([01]?\d|2[0-3]):([0-5]\d)$/.exec(t||'');if(!m)return!1;const d=new Date();d.setHours(+m[1],+m[2],0,0);localStorage.setItem(K_IN,d.getTime());return!0;}
    function validate(){const w=parseHM($('#durWork').value),b=parseHM($('#durBreak').value),r=parseHM($('#durRecovery').value);
      let ok=1;$('#errWork').textContent=$('#errBreak').textContent=$('#errRecovery').textContent=$('#errManual').textContent='';
      if(w==null||w<=0){$('#errWork').textContent=ERR.work;ok=0;}if(b==null||b<0){$('#errBreak').textContent=ERR.break;ok=0;}
      if(r==null||r<0){$('#errRecovery').textContent=ERR.recovery;ok=0;}
      const man=$('#manualCheckIn').value.trim();if(man&&!setManual(man)){ok=0;$('#errManual').textContent=ERR.manual;}
      if(ok){localStorage.setItem(K_W,fmtHM(w));localStorage.setItem(K_B,fmtHM(b));localStorage.setItem(K_R,fmtHM(r||0));}return ok;}
    function refresh(){const {W,B,R}=getDur();$('#sum').textContent=W!=null&&B!=null&&R!=null?fmtHM(W+B+R):'â€”';
      const v=localStorage.getItem(K_IN);if(!v)return $('#in').textContent=$('#out').textContent='â€”';
      const d=new Date(+v);$('#in').textContent=fmtClock.format(d);
      if(W&&B!=null&&R!=null){d.setMinutes(d.getMinutes()+W+B+R);$('#out').textContent=fmtClock.format(d);}else $('#out').textContent='â€”';}
    $('#checkin').onclick=()=>{if(!ensure())return;localStorage.setItem(K_IN,Date.now());refresh();};
    $('#reset').onclick=()=>{localStorage.removeItem(K_IN);refresh();};
    $('#settings').onclick=()=>$('#dlg').showModal();
    $('#save').onclick=()=>{if(validate()){$('#dlg').close();refresh();$('#checkin').disabled=false;$('#reset').disabled=false;}};
    document.addEventListener('change',e=>{if(e.target.name==='lang')setLang(e.target.value);});
    function ensure(){const {W,B}=getDur();const ok=W>0&&B!=null;if(!ok){$('#dlg').showModal();$('#checkin').disabled=true;$('#reset').disabled=true;}else{$('#dlg').open&&$('#dlg').close();$('#checkin').disabled=false;$('#reset').disabled=false;}return ok;}
    $('#dlg').addEventListener('cancel',e=>{const {W,B}=getDur();if(!(W&&B!=null))e.preventDefault();});
    $('#dlg').addEventListener('close',()=>{const {W,B}=getDur();if(!(W&&B!=null))setTimeout(()=>$('#dlg').showModal(),0);});
    setLang(localStorage.getItem(K_LANG)||((navigator.language||'en').startsWith('it')?'it':'en'));
    ensure();refresh();
    if('serviceWorker'in navigator)window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js'));
  </script>
</body>
</html>
