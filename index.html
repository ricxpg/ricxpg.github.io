<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Check In</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0f766e">
  <meta name="color-scheme" content="light dark">
  <link rel="icon" href="./icons/icon-192.png">
  <style>
    :root { --c:#0f766e; --bg:#fff; --fg:#111; --muted:#6b7280; --ring:rgba(15,118,110,.18); }
    @media (prefers-color-scheme: dark){
      :root { --bg:#0b0f10; --fg:#e5e7eb; --muted:#9ca3af; --ring:rgba(34,197,94,.25);}
    }
    html,body{height:100%}
    body { margin: 24px; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 640px;
           color: var(--fg); background: var(--bg); }
    h1 { margin: 0 0 12px 0; }
    .row { display:flex; justify-content:space-between; align-items:baseline; padding:10px 0; border-bottom: 1px dashed #e5e7eb22; }
    .row strong{font-weight:600}
    .toolbar { display:flex; gap:10px; margin-top: 18px; flex-wrap: wrap; }
    button { padding: 12px 16px; font-size: 16px; border: 0; border-radius: 10px; background: var(--c); color:#fff; cursor:pointer; }
    button.ghost{ background:#e6f3f2; color:#063d38; }
    @media (prefers-color-scheme: dark){
      button.ghost{ background:#103a36; color:#d1fae5; }
    }
    button:disabled{ opacity:.55; cursor:not-allowed }
    .muted{ color: var(--muted); font-size: 14px; }
    dialog::backdrop { background: rgba(0,0,0,.45); }
    dialog { border: 0; border-radius: 14px; padding: 18px; width: min(92vw, 560px); color: var(--fg); background: var(--bg); }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    input[type="time"]{ padding: 12px 12px; border: 1px solid #33415555; border-radius: 10px; font-size: 16px; background: transparent; color: var(--fg); }
    input[type="time"]:focus{ outline: none; box-shadow: 0 0 0 4px var(--ring); border-color: transparent; }
    .err{ color:#ef4444; font-size: 13px; min-height: 1.2em; }
    .actions{ display:flex; justify-content:flex-end; gap:10px; margin-top: 12px; }
    .kpi{ font-variant-numeric: tabular-nums; font-feature-settings: "tnum"; }
    .radio-row{ display:flex; gap:12px; align-items:center; }
    .radio{ display:flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #33415533; border-radius:10px; cursor:pointer; }
    .radio input{ accent-color: var(--c); }
  </style>
</head>
<body>
  <h1 id="t-title">Work Shift</h1>

  <div class="row"><strong id="t-checkin">Check-in</strong><span id="in" class="kpi">â€”</span></div>
  <div class="row"><strong id="t-total">Total (Work + Break + Recovery)</strong><span id="sum" class="kpi">â€”</span></div>
  <div class="row"><strong id="t-checkout">Check-out</strong><span id="out" class="kpi">â€”</span></div>

  <div class="toolbar">
    <button id="checkin" disabled><span id="t-btn-checkin">Check-in</span></button>
    <button id="reset" class="ghost" disabled><span id="t-btn-reset">Reset</span></button>
    <button id="settings" class="ghost"><span id="t-btn-settings">Settings</span></button>
  </div>
  <p class="muted" id="t-hint">12-hour format for English, 24-hour for Italian. Installable offline PWA. Data stored locally.</p>

  <!-- Settings dialog -->
  <dialog id="dlg">
    <h2 id="t-dlg-title" style="margin:0 0 8px 0">Settings</h2>
    <p id="t-dlg-desc" class="muted" style="margin-top:0">
      Enter durations with the clock (HH:MM). The app stays locked until you set Work and Lunch break.
    </p>

    <!-- Language selector -->
    <div class="field">
      <label id="t-lang-label">Language</label>
      <div class="radio-row">
        <label class="radio"><input type="radio" name="lang" value="en" id="lang-en"><span>ðŸ‡ºðŸ‡¸ English</span></label>
        <label class="radio"><input type="radio" name="lang" value="it" id="lang-it"><span>ðŸ‡®ðŸ‡¹ Italiano</span></label>
      </div>
    </div>

    <div class="grid">
      <div class="field">
        <label id="t-lbl-work" for="durWork">Work duration</label>
        <input id="durWork" type="time" step="60" autocomplete="off">
        <div id="errWork" class="err"></div>
      </div>
      <div class="field">
        <label id="t-lbl-break" for="durBreak">Lunch break</label>
        <input id="durBreak" type="time" step="60" autocomplete="off">
        <div id="errBreak" class="err"></div>
      </div>
      <div class="field">
        <label id="t-lbl-recovery" for="durRecovery">Recovery Time (optional)</label>
        <input id="durRecovery" type="time" step="60" autocomplete="off">
        <div id="errRecovery" class="err"></div>
      </div>
      <div class="field" style="grid-column: 1 / -1;">
        <label id="t-lbl-manual" for="manualCheckIn">Manual check-in (today) â€” optional</label>
        <input id="manualCheckIn" type="time" step="60" autocomplete="off">
        <div id="errManual" class="err"></div>
        <span class="muted" id="t-lbl-manual-help">If provided, todayâ€™s check-in will be set to this time when you press Save.</span>
      </div>
    </div>
    <div class="actions">
      <button id="save"><span id="t-btn-save">Save</span></button>
    </div>
  </dialog>

  <script>
    const K_W='workDurationHM',K_B='breakDurationHM',K_R='recoveryDurationHM',K_IN='checkinEpochMs',K_LANG='lang';

    const I18N={en:{title:"Work Shift",checkin:"Check-in",total:"Total (Work + Break + Recovery)",checkout:"Check-out",
      btn_checkin:"Check-in",btn_reset:"Reset",btn_settings:"Settings",
      hint:"12-hour format. Installable offline PWA. Data stored locally.",
      dlg_title:"Settings",dlg_desc:"Enter durations with the clock (HH:MM). The app stays locked until you set Work and Lunch break.",
      lang_label:"Language",lbl_work:"Work duration",lbl_break:"Lunch break",
      lbl_recovery:"Recovery Time (optional)",lbl_manual:"Manual check-in (today) â€” optional",
      lbl_manual_help:"If provided, todayâ€™s check-in will be set to this time when you press Save.",
      btn_save:"Save",err_work:"Enter a time (> 00:00)",err_break:"Enter a time (â‰¥ 00:00)",err_recovery:"Enter a valid time (â‰¥ 00:00)",err_manual:"Invalid time."},
      it:{title:"Turno di lavoro",checkin:"Check-in",total:"Totale (Lavoro + Pausa + Recupero)",checkout:"Check-out",
      btn_checkin:"Check-in",btn_reset:"Reset",btn_settings:"Impostazioni",
      hint:"Formato 24 ore. PWA installabile offline. Dati salvati in locale.",
      dlg_title:"Impostazioni",dlg_desc:"Inserisci le durate con lâ€™orologio (HH:MM). Lâ€™app resta bloccata finchÃ© non imposti Lavoro e Pausa.",
      lang_label:"Lingua",lbl_work:"Orario di lavoro",lbl_break:"Pausa pranzo",
      lbl_recovery:"Tempo di Recupero (opzionale)",lbl_manual:"Check-in manuale (oggi) â€” opzionale",
      lbl_manual_help:"Se compilato, il check-in di oggi verrÃ  impostato a questâ€™ora quando premi Salva.",
      btn_save:"Salva",err_work:"Inserisci un orario (> 00:00)",err_break:"Inserisci un orario (â‰¥ 00:00)",err_recovery:"Inserisci un orario valido (â‰¥ 00:00)",err_manual:"Ora non valida."}};

    const $=s=>document.querySelector(s);
    const TX=Object.fromEntries([...document.querySelectorAll('[id^="t-"]')].map(e=>[e.id.replace('t-',''),e]));
    let fmtClock=new Intl.DateTimeFormat('en-US',{hour:'2-digit',minute:'2-digit',hour12:true});
    const ERR={};

    const toMin=hhmm=>{if(!hhmm)return null;const m=/^([01]?\d|2[0-3]):([0-5]\d)$/.exec(hhmm.trim());if(!m)return null;return +m[1]*60+ +m[2];};
    const fmtHM=mins=>{const h=Math.floor(mins/60),m=mins%60;return`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;};
    const getDur=()=>({W:toMin(localStorage.getItem(K_W)),B:toMin(localStorage.getItem(K_B)),R:toMin(localStorage.getItem(K_R)||'00:00')});
    const setManual=t=>{const m=toMin(t);if(m==null)return!1;const d=new Date();d.setHours(Math.floor(m/60),m%60,0,0);localStorage.setItem(K_IN,d.getTime());return!0;};

    function setLang(lang){
      const L=I18N[lang]||I18N.en;
      for(const k in TX){if(TX[k])TX[k].innerHTML=L[k]||TX[k].innerHTML;}
      (lang==='it'?$('#lang-it'):$('#lang-en')).checked=true;
      localStorage.setItem(K_LANG,lang);
      ERR.work=L.err_work;ERR.break=L.err_break;ERR.recovery=L.err_recovery;ERR.manual=L.err_manual;
      fmtClock=new Intl.DateTimeFormat(lang==='it'?'it-IT':'en-US',{hour:'2-digit',minute:'2-digit',hour12:lang!=='it'});
    }

    function validate(){
      const wVal=$('#durWork').value, bVal=$('#durBreak').value, rVal=$('#durRecovery').value;
      let ok=1; $('#errWork').textContent=$('#errBreak').textContent=$('#errRecovery').textContent=$('#errManual').textContent='';

      const w=toMin(wVal); if(w==null || w<=0){ $('#errWork').textContent=ERR.work; ok=0; }
      const b=toMin(bVal); if(b==null || b<0){ $('#errBreak').textContent=ERR.break; ok=0; }

      let r=0;
      if (rVal) {
        const rv=toMin(rVal);
        if (rv==null || rv<0){ $('#errRecovery').textContent=ERR.recovery; ok=0; }
        else r=rv;
      }

      const man=$('#manualCheckIn').value.trim();
      if(man && !setManual(man)){ $('#errManual').textContent=ERR.manual; ok=0; }

      if(!ok) return false;

      localStorage.setItem(K_W, fmtHM(toMin(wVal)));
      localStorage.setItem(K_B, fmtHM(toMin(bVal)));
      localStorage.setItem(K_R, fmtHM(r)); // 00:00 if empty
      return true;
    }

    function ensure(){
      const {W,B}=getDur();
      const ok = (W!=null && W>0) && (B!=null && B>=0);
      if(!ok){ openSettingsPrefilled(); $('#checkin').disabled=true; $('#reset').disabled=true; }
      else { if($('#dlg').open) $('#dlg').close(); $('#checkin').disabled=false; $('#reset').disabled=false; }
      return ok;
    }

    function openSettingsPrefilled(){
      $('#durWork').value     = localStorage.getItem(K_W) || '';
      $('#durBreak').value    = localStorage.getItem(K_B) || '';
      $('#durRecovery').value = localStorage.getItem(K_R) || '';
      $('#manualCheckIn').value = '';
      $('#dlg').showModal();
    }

    function refresh(){
      const {W,B,R}=getDur();
      const w=W??0, b=B??0, r=R??0;
      $('#sum').textContent = (W!=null && B!=null) ? fmtHM(w+b+r) : 'â€”';

      const v=localStorage.getItem(K_IN);
      if(!v){ $('#in').textContent='â€”'; $('#out').textContent='â€”'; return; }
      const d=new Date(+v);
      $('#in').textContent=fmtClock.format(d);
      if(W!=null && B!=null){ d.setMinutes(d.getMinutes()+w+b+r); $('#out').textContent=fmtClock.format(d); }
      else $('#out').textContent='â€”';
    }

    // buttons
    $('#checkin').onclick=()=>{ if(!ensure()) return; localStorage.setItem(K_IN, Date.now()); refresh(); };
    $('#reset').onclick =()=>{ localStorage.removeItem(K_IN); refresh(); };
    $('#settings').onclick=()=>{ openSettingsPrefilled(); };
    $('#save').onclick    =()=>{ if(validate()){ $('#dlg').close(); refresh(); $('#checkin').disabled=false; $('#reset').disabled=false; } };
    document.addEventListener('change',e=>{ if(e.target.name==='lang') setLang(e.target.value); });

    // block closing without required data
    $('#dlg').addEventListener('cancel',e=>{ const {W,B}=getDur(); if(!(W!=null && W>0 && B!=null)) e.preventDefault(); });
    $('#dlg').addEventListener('close', ()=>{ const {W,B}=getDur(); if(!(W!=null && W>0 && B!=null)) setTimeout(()=>$('#dlg').showModal(),0); });

    // init
    setLang(localStorage.getItem(K_LANG) || ((navigator.language||'en').startsWith('it')?'it':'en'));
    ensure(); refresh();

    // PWA registration + auto-reload on updates (controllerchange)
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js'));
      navigator.serviceWorker.addEventListener('controllerchange', ()=>window.location.reload());
    }
  </script>
</body>
</html>
